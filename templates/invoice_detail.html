{% extends "base.html" %}
{% block title %}Invoice {{ inv.invoice_no }} · BV Management{% endblock %}
{% block content %}
  <div class="h1">Invoice {{ inv.invoice_no }}</div>

  {% if warns and warns|length %}
    <div class="card warn"><div class="h2">Compliance warnings</div>
      <ul>{% for w in warns %}<li>{{ w }}</li>{% endfor %}</ul>
    </div>
  {% endif %}

  <div class="grid section" style="grid-template-columns: 1fr 1fr">
    <div class="card">
      <div class="h2">Header</div>
      <div class="mut">Issue: {{ inv.issue_date }} • Supply: {{ inv.supply_date }} • Due: {{ inv.due_date }} • {{ inv.currency }}</div>
      <div class="mut">VAT scheme: {{ inv.vat_scheme }}</div>
      <div class="mut">Status: {{ inv.status }}</div>
      <div class="mut">Notes: {{ inv.notes or '—' }}</div>
    </div>
    <div class="card">
      <div class="h2">Customer</div>
      <div>{{ inv.client_name }}</div>
      <div class="mut">{{ inv.client_address }}</div>
      <div class="mut">VAT: {{ inv.client_vat_number or '—' }}</div>
    </div>
  </div>

  <div class="card section">
    <div class="h2">Lines</div>
    <table>
      <thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>VAT %</th><th>Net</th><th>VAT</th><th>Total</th></tr></thead>
      <tbody>
      {% for l in inv.lines %}
        <tr>
          <td>{{ l.description }}</td>
          <td>{{ '%.2f'|format(l.qty) }}</td>
          <td>€ {{ '%.2f'|format(l.unit_price) }}</td>
          <td>{{ '%.2f'|format(l.vat_rate) }}</td>
          <td>€ {{ '%.2f'|format(l.line_net) }}</td>
          <td>€ {{ '%.2f'|format(l.line_vat) }}</td>
          <td>€ {{ '%.2f'|format(l.line_total) }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div class="row right" style="gap:24px">
      <div>Net: <strong>€ {{ '%.2f'|format(inv.net_total) }}</strong></div>
      <div>VAT: <strong>€ {{ '%.2f'|format(inv.vat_total) }}</strong></div>
      <div>Gross: <strong>€ {{ '%.2f'|format(inv.gross_total) }}</strong></div>
      <div>Paid: <strong>€ {{ '%.2f'|format(inv.paid_total) }}</strong></div>
      <div>Balance: <strong>€ {{ '%.2f'|format(inv.balance) }}</strong></div>
    </div>
  </div>

  <div class="grid section" style="grid-template-columns: 2fr 1fr">
    <div class="card">
      <div class="h2">Payments</div>
      <table>
        <thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Reference</th></tr></thead>
        <tbody>
        {% for p in inv.payments %}
          <tr><td>{{ p.date }}</td><td>€ {{ '%.2f'|format(p.amount) }}</td><td>{{ p.method }}</td><td>{{ p.reference or '' }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="h2">Record Payment</div>
      <form method="post" action="{{ url_for('pay_invoice', invoice_id=inv.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="row">
          <input type="date" name="date" required style="flex:1">
          <input type="number" step="0.01" name="amount" value="{{ '%.2f'|format(inv.balance) }}" style="flex:1">
        </div>
        <div class="row section">
          <select name="method" style="flex:1">
            <option value="bank">Bank</option><option value="western_union">Western Union</option><option value="cash">Cash</option><option value="other">Other</option>
          </select>
          <input name="reference" placeholder="Ref" style="flex:1">
        </div>
        <div class="row right section"><button>Record</button></div>
      </form>
    </div>
  </div>
{% endblock %}
