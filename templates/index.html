<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>BV Management (Dutch-compliant)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0f1226; --panel:#171a33; --mut:#9aa3b2; --hi:#f3f4f6; --acc:#7c5cff; --green:#22c55e; --red:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--hi);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--acc);text-decoration:none} .container{max-width:1200px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px} .grid.cards{grid-template-columns:repeat(auto-fit,minmax(230px,1fr))}
    .card{background:var(--panel);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,.06)}
    .mut{color:var(--mut);font-size:12px} .h1{font-size:22px;font-weight:700;margin:0 0 8px}
    .h2{font-size:16px;font-weight:700;margin:0 0 8px} .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#121533;color:#fff}
    label{font-size:12px;color:var(--mut)} button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;background:var(--acc);color:#fff;font-weight:600}
    table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{padding:10px 12px;text-align:left}
    tr{background:rgba(255,255,255,.03)} tr:hover{background:rgba(255,255,255,.05)} .right{justify-content:flex-end}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px} .flash{padding:10px 12px;border-radius:10px;margin:8px 0}
    .mt8{margin-top:8px}.mt16{margin-top:16px}.mt24{margin-top:24px}.mt32{margin-top:32px}.col-2{grid-template-columns:repeat(2,1fr)}
    .warn{border-left:5px solid #f59e0b} .ok{border-left:5px solid #22c55e} .err{border-left:5px solid #ef4444}
    .section{margin-top:24px}
    .line-row{display:grid;grid-template-columns:2fr 0.6fr 0.8fr 0.8fr auto;gap:8px;align-items:center;margin-bottom:8px}
    .add-line{background:#0ea5e9}
  </style>
</head>
<body>
<div class="container">

  <div class="h1">BV Management Dashboard (Dutch rules)</div>
  <div class="mut">Pre‑filled with your company details to avoid blanks. Replace the placeholder VAT number when you have the final value.</div>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for cat,msg in messages %}
      <div class="flash card {% if cat=='success' %}ok{% elif cat=='danger' %}err{% elif cat=='warning' %}warn{% endif %}">
        {{ msg }}
      </div>
    {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- KPIs -->
  <div class="grid cards mt16">
    <div class="card"><div class="mut">YTD Income</div><div class="h1">€ {{ '%.2f'|format(ytd_income) }}</div></div>
    <div class="card"><div class="mut">YTD Expenses (gross)</div><div class="h1">€ {{ '%.2f'|format(ytd_expenses) }}</div></div>
    <div class="card">
      <div class="mut">VAT summary ({{ q_start }} → {{ q_end }})</div>
      <div>Sales 21%: € {{ '%.2f'|format(sales_21) }}</div>
      <div>Sales 9%: € {{ '%.2f'|format(sales_9) }}</div>
      <div>Sales 0%/Exempt: € {{ '%.2f'|format(sales_0) }}</div>
      <div class="mt8">Output VAT: € {{ '%.2f'|format(vat_out) }}</div>
      <div>Input VAT: € {{ '%.2f'|format(vat_in) }}</div>
      <div class="h2 mt8">Net VAT due: € {{ '%.2f'|format(vat_due) }}</div>
      <div class="mut mt8">Reverse‑charge (BTW verlegd) shows as net without VAT here.</div>
    </div>
  </div>

  <!-- Company Settings (pre-filled with your details) -->
  <div class="card section">
    <div class="h2">Company Settings (required on Dutch invoices)</div>
    <form method="post" action="{{ url_for('save_settings') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="grid col-2">
        <div>
          <label>Company name</label>
          <input name="company_name" value="{{ company.company_name }}" required>
        </div>
        <div>
          <label>KVK</label>
          <input name="kvk" value="{{ company.kvk }}" required>
        </div>
      </div>
      <div class="grid col-2 mt8">
        <div>
          <label>RSIN</label>
          <input name="rsin" value="{{ company.rsin }}" required>
        </div>
        <div>
          <label>VAT number (BTW-nummer)</label>
          <input name="vat_number" value="{{ company.vat_number }}" required>
        </div>
      </div>
      <div class="grid col-2 mt8">
        <div>
          <label>Invoice prefix</label>
          <input name="invoice_prefix" value="{{ company.invoice_prefix or 'INV' }}" required>
        </div>
        <div>
          <label>IBAN | BIC</label>
          <div class="row">
            <input name="iban" value="{{ company.iban }}" required style="flex:2">
            <input name="bic" value="{{ company.bic }}" required style="flex:1">
          </div>
        </div>
      </div>
      <div class="grid col-2 mt8">
        <div>
          <label>Address (street)</label>
          <input name="address" value="{{ company.address }}" required>
        </div>
        <div>
          <label>Postcode, City, Country</label>
          <div class="row">
            <input name="postcode" placeholder="Postcode" value="{{ company.postcode }}" required style="flex:1">
            <input name="city" placeholder="City" value="{{ company.city }}" required style="flex:1">
            <input name="country" placeholder="Country" value="{{ company.country }}" required style="flex:1">
          </div>
        </div>
      </div>
      <div class="row right mt16"><button>Save</button></div>
    </form>
    <div class="mut mt8">
      Registered name: <strong>Climate Resilience Fundraising Platform B.V.</strong><br/>
      Address: Fluwelen Burgwal, 2511CJ Den Haag, Netherlands<br/>
      KVK: 94437289 &nbsp;|&nbsp; RSIN: 866777398 &nbsp;|&nbsp; VAT: {{ company.vat_number }}<br/>
      IBAN: {{ company.iban }} &nbsp;|&nbsp; BIC: {{ company.bic }}
    </div>
  </div>

  <!-- Create Invoice -->
  <div class="card section">
    <div class="h2">Create Invoice (Dutch-compliant)</div>
    <form method="post" action="{{ url_for('create_invoice') }}" id="invForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <div class="grid col-2">
        <div>
          <label>Issue date</label>
          <input type="date" name="issue_date" required>
        </div>
        <div>
          <label>Supply date (performance)</label>
          <input type="date" name="supply_date" required>
        </div>
      </div>

      <div class="grid col-2 mt8">
        <div>
          <label>Due date</label>
          <input type="date" name="due_date" required>
        </div>
        <div>
          <label>Currency</label>
          <select name="currency"><option value="EUR" selected>EUR</option></select>
        </div>
      </div>

      <div class="grid col-2 mt8">
        <div>
          <label>Customer name</label>
          <input name="client_name" required>
        </div>
        <div>
          <label>Customer VAT (if reverse charge)</label>
          <input name="client_vat_number" placeholder="EU VAT number (if BTW verlegd)">
        </div>
      </div>
      <div class="mt8">
        <label>Customer address</label>
        <textarea name="client_address" rows="2" required></textarea>
      </div>

      <div class="grid col-2 mt8">
        <div>
          <label>VAT scheme</label>
          <select name="vat_scheme" id="vat_scheme">
            <option value="STANDARD" selected>STANDARD (charge 21%/9%/0%)</option>
            <option value="REVERSE_CHARGE_EU">Reverse charge (BTW verlegd)</option>
            <option value="ZERO_OUTSIDE_EU">0% export outside EU</option>
            <option value="EXEMPT">Exempt</option>
          </select>
        </div>
        <div>
          <label>Notes (e.g., “BTW verlegd art. 12 Wet OB”)</label>
          <input name="notes" placeholder="Optional legal note">
        </div>
      </div>

      <div class="mt16"><div class="h2">Lines</div></div>

      <div id="lines">
        <div class="line-row">
          <input name="line_desc" placeholder="Description" required>
          <input name="line_qty" type="number" step="0.01" placeholder="Qty" value="1" required>
          <input name="line_price" type="number" step="0.01" placeholder="Unit price" required>
          <select name="line_vat" class="line-vat">
            <option value="21">21%</option>
            <option value="9">9%</option>
            <option value="0" selected>0%</option>
          </select>
          <button type="button" onclick="removeLine(this)">✕</button>
        </div>
      </div>

      <div class="row mt8">
        <button type="button" class="add-line" onclick="addLine()">+ Add line</button>
      </div>

      <div class="row right mt16">
        <button>Create Invoice</button>
      </div>
    </form>
    <div class="mut mt8">
      Your invoice number, supplier details (KVK/RSIN/VAT), IBAN/BIC, issue & supply dates, line VAT and customer address are all enforced here to avoid blanks.
    </div>
  </div>

  <!-- Unpaid invoices quick-pay -->
  <div class="card section">
    <div class="h2">Unpaid Invoices</div>
    {% if unpaid_invoices|length == 0 %}
      <div class="mut">No unpaid invoices.</div>
    {% else %}
      <table>
        <thead><tr><th>Invoice</th><th>Client</th><th>Due</th><th>Status</th><th>Balance</th><th>Pay</th></tr></thead>
        <tbody>
        {% for inv in unpaid_invoices %}
          <tr>
            <td>{{ inv.invoice_no }}</td>
            <td>{{ inv.client_name }}</td>
            <td>{{ inv.due_date }}</td>
            <td>{{ inv.status }}</td>
            <td>€ {{ '%.2f'|format(inv.balance) }}</td>
            <td>
              <form method="post" action="{{ url_for('pay_invoice', invoice_id=inv.id) }}" class="row">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="date" name="date" required style="width:150px">
                <input type="number" step="0.01" name="amount" value="{{ '%.2f'|format(inv.balance) }}" style="width:120px">
                <select name="method" style="width:160px">
                  <option value="bank">Bank</option>
                  <option value="western_union">Western Union</option>
                  <option value="cash">Cash</option>
                  <option value="other">Other</option>
                </select>
                <input name="reference" placeholder="Ref" style="width:140px">
                <button>Record</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <!-- Record standalone income & expenses -->
  <div class="grid col-2 section">
    <div class="card">
      <div class="h2">Record Income (No Invoice)</div>
      <form method="post" action="{{ url_for('add_income') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="grid col-2">
          <div><label>Date</label><input type="date" name="date" required></div>
          <div><label>Amount</label><input type="number" step="0.01" name="amount" required></div>
        </div>
        <div class="grid col-2 mt8">
          <div>
            <label>Method</label>
            <select name="method">
              <option value="bank">Bank</option>
              <option value="western_union">Western Union</option>
              <option value="cash">Cash</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div><label>Reference</label><input name="reference" placeholder="Bank/WU ref"></div>
        </div>
        <div class="mt8"><label>Note</label><input name="note" placeholder="Optional"></div>
        <div class="row right mt16"><button>Save Income</button></div>
      </form>
    </div>

    <div class="card">
      <div class="h2">Add Expense (with VAT)</div>
      <form method="post" enctype="multipart/form-data" action="{{ url_for('add_expense') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="grid col-2">
          <div><label>Date</label><input type="date" name="date" required></div>
          <div><label>Gross amount (incl. VAT)</label><input type="number" step="0.01" name="amount_gross" required></div>
        </div>
        <div class="grid col-2 mt8">
          <div><label>VAT rate</label>
            <select name="vat_rate">
              <option value="21" selected>21%</option>
              <option value="9">9%</option>
              <option value="0">0% / Exempt</option>
            </select>
          </div>
          <div><label>Currency</label><select name="currency"><option value="EUR" selected>EUR</option></select></div>
        </div>
        <div class="grid col-2 mt8">
          <div><label>Vendor</label><input name="vendor" required></div>
          <div><label>Category</label><input name="category" list="cats" placeholder="e.g., Software" required>
            <datalist id="cats">
              <option>Software</option><option>DGA Salary</option><option>Tax - Wage</option>
              <option>Tax - CIT</option><option>Travel</option><option>Office</option>
            </datalist>
          </div>
        </div>
        <div class="mt8"><label>Description</label><input name="description" placeholder="Optional notes"></div>
        <div class="mt8"><label>Receipt (PDF/JPG/PNG)</label><input type="file" name="receipt" accept=".pdf,.png,.jpg,.jpeg"></div>
        <div class="row right mt16"><button>Save Expense</button></div>
      </form>
      <div class="mut mt8">We compute input VAT from the gross based on your selected rate and include it in your quarterly VAT summary.</div>
    </div>
  </div>

</div>

<script>
  const vatScheme = document.getElementById('vat_scheme');
  function syncVatOptions() {
    if (!vatScheme) return;
    const rc = vatScheme.value === 'REVERSE_CHARGE_EU';
    const zero = vatScheme.value === 'ZERO_OUTSIDE_EU' || vatScheme.value === 'EXEMPT';
    document.querySelectorAll('.line-vat').forEach(sel => {
      if (rc || zero) { sel.value = '0'; sel.disabled = true; }
      else { sel.disabled = false; }
    });
  }
  if (vatScheme) {
    vatScheme.addEventListener('change', syncVatOptions);
    syncVatOptions();
  }

  function addLine() {
    const row = document.createElement('div');
    row.className = 'line-row';
    row.innerHTML = `
      <input name="line_desc" placeholder="Description" required>
      <input name="line_qty" type="number" step="0.01" placeholder="Qty" value="1" required>
      <input name="line_price" type="number" step="0.01" placeholder="Unit price" required>
      <select name="line_vat" class="line-vat">
        <option value="21">21%</option>
        <option value="9">9%</option>
        <option value="0" selected>0%</option>
      </select>
      <button type="button" onclick="removeLine(this)">✕</button>
    `;
    document.getElementById('lines').appendChild(row);
    syncVatOptions();
  }
  function removeLine(btn) {
    const parent = btn.closest('.line-row');
    if (parent && document.querySelectorAll('#lines .line-row').length > 1) {
      parent.remove();
    }
  }
</script>
</body>
</html>
